name: ci

on:
  push:
    branches: [main]
  pull_request:

jobs:
  linux-debug:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure (Debug)
        run: cmake --preset linux-debug

      - name: Build (Debug)
        run: cmake --build --preset linux-debug -j

      - name: Test (Debug)
        run: ctest --preset linux-debug --output-on-failure

  linux-asan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure (ASan)
        run: cmake --preset linux-asan

      - name: Build (ASan)
        run: cmake --build --preset linux-asan -j

      - name: Test (ASan)
        run: ctest --preset linux-asan --output-on-failure

  linux-ubsan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure (UBSan)
        run: cmake --preset linux-ubsan

      - name: Build (UBSan)
        run: cmake --build --preset linux-ubsan -j

      - name: Test (UBSan)
        run: ctest --preset linux-ubsan --output-on-failure

  package-smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install/package smoke
        env:
          HWM14_INSTALL_PREFIX: ${{ runner.temp }}/hwm14-install
        run: tools/validate_package_install.sh
